<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<html lang="en">
	
        <meta charset="utf-8">

<!-- Load d3.js and the geo projection plugin -->
<script src="http://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>

<script src="http://d3js.org/d3.v5.min.js"></script>

<script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>
<!-- Load Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="icon" href="favicon.png" sizes="16x16">

<!-- Create an element where the map will take place -->
<body>
  

<!-- 
<div style="float:left">
<div style="width: 100px; text-align:center; color: black; background-color: pink; padding: 5px;margin-left:10px">  
  <input type="checkbox" class="checkbox" value="A" checked><label><strong>score:9.0-10</strong></label>
</div>

<div style="width: 100px; text-align:center; color: black; background-color: pink; padding: 5px;margin-left:10px">
  <input type="checkbox" class="checkbox" value="B" checked><label><strong>score:8.0-9.0</strong></label>
</div>

<div style="width: 100px; text-align:center; color: black; background-color: pink; padding: 5px;margin-left:10px">
  <input type="checkbox" class="checkbox" value="C" checked><label><strong>score:7.0-8.0</strong></label>
</div>
<div style="width: 100px; text-align:center; color: black; background-color: pink; padding: 5px;margin-left:10px">
  <input type="checkbox" class="checkbox" value="D" checked><label><strong>score:6.0-7.0</strong></label>
</div> -->


<div class="container">
    <div class="col-md-12">

<div class=" text-center" style="
margin-top: 20px;
">
<!--Title-->
  <h1>Trends in European Hotel Reviews  </h1>
  <hr>
</div>
</div>
    <div class="row">
        <div class="col-lg-2 col-sm-12 " style="margin-top:10%; margin-bottom:10%">
            <div class="card text-center">
                <h5 class="card-header">Hotel Average Score</h5>

                <div class="card-body">
                   
                    <input type="checkbox" class="checkbox" value="A" checked><label><strong> 9.0-10</strong></label>
                    <br>
                    <input type="checkbox" class="checkbox" value="B" checked><label><strong> 8.0-9.0</strong></label>
                    <br>
                    <input type="checkbox" class="checkbox" value="C" checked><label><strong> 7.0-8.0</strong></label>
                    <br>
                    <input type="checkbox" class="checkbox" value="D" checked><label><strong> 6.0-7.0</strong></label>
                    <br>
                    <input type="checkbox" class="checkbox" value="E" checked><label><strong> 5.0-6.0</strong></label>

                  </div>
               
          </div>
        </div>
      <div class="col-lg-10">
          <div id="mapid"> </div>

      </div>

    </div>
<!--Hotel Info-->
<div class="text-center" style="
margin-top: 20px;
">
<h2 id="Hotel_Name_display" ></h2>

<h4 id="Hotel_Score_display"></h4>

<p id="Hotel_Address_display"></p>
</div>

<div class ="row">
<div class="col-md-6 text-center" >
    <h4 id="PositiveComments"></h4>
    </div>

    <div class="col-md-6 text-center" >

    <h4 id="NegativeComments"></h4>
  </div>
</div>

<!--Word Clouds-->
<div class="myCloud" style="text-align:center"></div>


<div class ="row">
    <div class="col-md-6 text-center" >
        <h4 id="PieComments"></h4>
        </div>
    
        <div class="col-md-6 text-center" >
    
        <h4 id="NegativeComments"></h4>
    </div>
</div>
    
<div class="col-lg-6 text-center"> 
<!--Bar Charts-->
<div class="barChart"></div>

<div class="col-lg-6 text-center"> 
<!--Pie Charts-->
  <div  id="piechart">   </div>
  <div class="text-center"> 
      <p style="color:#66a61d;" id="Leisure"> </p>
      <p style="color:#e6ab03;"id="Business"></p>
   
    </div>
  </div>
  <div class="col-lg-12">
</div>
</div>
</div>



<!-- Footer -->
<footer class="page-footer" style="background-color:gray">
    <div class="container">
        <div class="col-md-12 text-center" >
          <h5 style="   color:white; padding-top: 10px;">COMPSCI 590V Data Visualization And Analysis - Spring 2018</h5>
        </div>
        <div class="row">

        <!-- Grid column -->
        <div class="col-md-12" >
            <div class="mb-5 text-center">
               
                    <a href="https://github.com/aawwsed10/Euro-hotel-reviews-vis"style="color:#fbfac6;"><i class="fa fa-github" style="font-size:50px"></i> </a> 
                  
              </div>
              </div>

</div>
</div>
  </footer>
</body>


<style>
      
#mapid { height: 500px;
         width:100%;
/* 		 margin-left:200px;*/
		 float:left
		 
	 }

.legend { text-align: left; line-height: 28px; color: #555; } .legend i { width: 28px; height: 28px; float: left; margin-right: 8px; opacity: 0.7; }

.info {
    padding: 16px 18px;
    font: 14px/28px Arial, Helvetica, sans-serif;
    background: white;
    background: #ffffff;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

svg{pointer-events:all}
label {
    margin: .4rem;
}
.card-header {
    background-color: #fbfac6;
}

.h1, h1 {
    font-size: 2.5rem;
}
.h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
  margin-top:.5rem;
    margin-bottom: .5rem;
    font-weight: 500;
    line-height: 1.2;
}
h1, h2, h3, h4, h5, h6 {
  margin-top:.5rem;
    margin-bottom: .5rem;
}
*, ::after, ::before {
    box-sizing: border-box;
}
user agent stylesheet
h1 {
    display: block;
    font-size: 2em;
    margin-block-start: 0.67em;
    margin-block-end: 0.67em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    font-weight: bold;
}
.text-center {
    text-align: center!important;
}
body {
  color: #5B779F;
}
.tooltippie1 {
  background: #eee;
  box-shadow: 0 0 5px #999999;
  color: #333;
  display: none;
  font-size: 18px;
  left: 130px;
  padding: 10px;
  position: absolute;
  text-align: center;
  top: 95px;
  width: 80px;
  z-index: 10;
}


</style>

<!-- <script type='text/javascript' src='data/Hotel_data_test.json'></script> -->
<script type='text/javascript' src='data/Hotel_Reviews_clean_mapData.json'></script>
<script type='text/javascript' src='data/Neg_Review.json'></script>
<script type='text/javascript' src='data/Pos_Review.json'></script>
<script type='text/javascript' src='data/Hotel_Reviews_clean_test_v2.json'></script>




<script>


var hotelReviewByName = d3.nest()
  .key(function(d) {return d.Hotel_Name; })
  .object(hotels_reviews);

var hotelGroup = d3.nest()
  .key(function(d) { return d.Hotel_Name; })
  .object(hotels);

var color = d3.scale.linear()
        .domain([0,1,2,3,4,5,6,10,15,20,100])
        .range(["#222", "#333", "#444", "#555", "#666", "#777", "#888", "#999", "#aaa", "#bbb", "#ccc", "#ddd"]);

///PIE CHART
var piecolor = d3.scaleOrdinal()
  .domain([ "c", "d", "e", "f"])
  .range(d3.schemeDark2);

  var Piewidth = 250
      Pieheight = 250
      Piemargin = 40
      var piesvg = d3.select("#piechart")
    .append("svg")
      .attr("width", Piewidth)
      .attr("height", Pieheight)
    .append("g")
      .attr("transform", "translate(" + Piewidth / 2 + "," + Pieheight / 2 + ")");

      var Pieradius = Math.min(Piewidth, Pieheight) / 2 - Piemargin
     var label = d3.arc()
            .outerRadius(Pieradius)
            .innerRadius(Pieradius - 80);
			
function pieChart(name,type){

  // The radius of the pieplot is half the width or half the height (smallest one).

    
var groupByTripType = d3.nest()
  .key(function(d) {return d.Trip_Type; })
  .rollup(function(v) { return {
    count: v.length, avg: d3.mean(v, function(d) { return d.Reviewer_Score; })
     }})
  .object(hotelReviewByName[name]);

  updatePie(groupByTripType)
  
  var total = groupByTripType["Leisure trip"]["count"]+ groupByTripType["Business trip"]["count"]
  document.getElementById("Leisure").innerHTML= ("Leisure Trip: " + groupByTripType["Leisure trip"]["count"].toString() +"   ("+Math.round(  groupByTripType["Leisure trip"]["count"]/total*100)+"%)" )
  document.getElementById("Business").innerHTML= ("Business Trip: " + groupByTripType["Business trip"]["count"].toString() +"   ("+Math.round(  groupByTripType["Business trip"]["count"]/total*100)+"%)" )


  console.log(hotelReviewByName[name]);
  console.log(groupByTripType["Business Trip"]);


}

var tooltippie1 = d3.select('#piechart') 
.append('div')  
.attr('class', 'tooltip');
tooltippie1.append('div')
.attr('class', 'label');

tooltippie1.append('div')  
.attr('class', 'count'); 

tooltippie1.append('div') // add divs to the tooltip defined above  
  .attr('class', 'percent');
  
function updatePie(data) {

// Compute the position of each group on the pie:
var pie = d3.pie()
  .value(function(d) { console.log(d);return d.value.count; })
  .sort(function(a, b) { console.log(a) ; return d3.ascending(a.key, b.key);} ) // This make sure that group order remains the same in the pie chart
var data_ready = pie(d3.entries(data))
console.log(data_ready);


// map to data
var u = piesvg.selectAll("path")
  .data(data_ready)

// Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
u
  .enter()
  .append('path')
  .merge(u)
  .transition()
  .duration(1000)
  .attr('d', d3.arc()
    .innerRadius(0)
    .outerRadius(Pieradius)
  )
  .attr('fill', function(d){ return(piecolor(d.data.key)) })
  .attr("stroke", "white")
  .style("stroke-width", "2px")
  .style("opacity", 1)
 
                               
// remove the group that is not present anymore
u
  .exit()
  .remove()

}


///BAR CHARTS

function barChart(name){
	var w = 400;
	var h = 250;
	
	var xScale = d3.scaleBand()
		.domain(d3.range(dataset.length))
		.rangeRound([0, w])
		.paddingInner(0.05);

	var yScale = d3.scaleLinear()
		.domain([0, d3.max(dataset)])
		.range([0, h]);
	
	var svg = d3.select(".barChart").append("svg")
		.attr("width",w)
		.attr("height",h)
		.append("g")
        .attr("transform", "translate("+(width / 2)+","+(height / 2)+")");
		
		
var groupByNationality = d3.nest()
  .key(function(d) {return d.Reviewer_Nationality; })
  .rollup(function(v) { return {
    count: v.length, avg: d3.mean(v, function(d) { return d.Reviewer_Score; })
     }})
  .object(hotelReviewByName[name]);

  updateBars(groupByNationality)

  console.log(hotelReviewByName[name]);
  console.log(groupByNationality);
		
		
/*		
	function draw() {
		//Create bars
		svg.selectAll("rect")
		   .data(dataset)
		   .enter()
		   .append("rect")
		   .attr("x", function(d, i) {
		   		return xScale(i);
		   })
		   .attr("y", function(d) {
		   		return h - yScale(d);
		   })
		   .attr("width", xScale.bandwidth())
		   .attr("height", function(d) {
				return yScale(d);
			})
		   .attr("fill", function(d) {
				return "rgb(0, 0, " + Math.round(d * 10) + ")";
		   })
		   .on("mouseover", function(d) {

				//Get this bar's x/y values, then augment for the tooltip
				var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.bandwidth() / 2;
				var yPosition = parseFloat(d3.select(this).attr("y")) + 14;

				//Create the tooltip label
				svg.append("text")
				   .attr("id", "tooltip")
				   .attr("x", xPosition)
				   .attr("y", yPosition)
				   .attr("text-anchor", "middle")
				   .attr("font-family", "sans-serif")
				   .attr("font-size", "11px")
				   .attr("font-weight", "bold")
				   .attr("fill", "black")
				   .text(d);

		   })
		   .on("mouseout", function() {
			   
				//Remove the tooltip
				d3.select("#tooltip").remove();
					
		   })
	}*/
	
	function updateBar(data) {
// TODO

}
}


///WORD CLOUDS
function wordCloud(d, type) {

    var fill = d3.scale.category20();
    var width = 450;
    var height = 350;

    var svg = d3.select(".myCloud").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate("+(width / 2)+","+(height / 2)+")");

    function draw(words) {
        var cloud = svg.selectAll("g text")
                    .data(words, function(d) { return d.text; })

        cloud.enter()
            .append("text")
            .style("font-size", function(d) { return d.size + "px"; })
            .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
            })
            .attr("text-anchor", "middle")
            .text(function(d) { return d.text; });

        if (type === "pos") {
          console.log(fill);
            cloud.style("fill", function(d, i) { return fill(i); });
        }
        if (type === "neg") {
            cloud.style("fill", function(d, i) { return color(i); });
        }

        cloud.transition()
            .duration(1000)
            .style("font-size", function(d) { return d.size + "px"; })
            .attr("transform", function(d) {
                return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
            })
            .attr("text-anchor", "middle");

        cloud.exit()
            .transition()
            .duration(500)
            .remove();
    }

    return {
        updateCloud(words) {
            d3.layout.cloud().size([width, height])
                .words(words)
                .padding(0)
                .rotate(function() { return ~~(Math.random() * 2) * 90; })
                .font("Impact")
                .fontSize(function(d) { return d.size; })
                .on("end", draw)
                .start();
        }
    }


}

var pos_cloud = wordCloud("body", "pos");
var neg_cloud = wordCloud("body", "neg");
	
function pos_review(pos_cloud, selected_hotel) {
    var pos_data = Pos_Review[selected_hotel];
    pos_cloud.updateCloud(pos_data);
}

function neg_review(neg_cloud, selected_hotel) {
    var neg_data = Neg_Review[selected_hotel];
    neg_cloud.updateCloud(neg_data);
}
</script>

<script>
// mapid is the id of the div where the map will appear

var map = L.map( 'mapid', {
  center: [50.0, 5.0],
  minZoom: 5,
  zoom: 5
})

// Add a tile to the map = a background. Comes from OpenStreetmap
L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    maxZoom: 17,
    }).addTo(map);
// Add a svg layer to the map
L.svg().addTo(map);
  
var dotColor = d3.scaleSequential(d3.interpolateRdYlGn)
            .domain([6,10])
            
// get color from avg score
var getColor  = function(Average_Score){
  if(Average_Score =="<6"){
    Average_Score = 6;
  }
  return(dotColor(Average_Score));
}

// Select the svg area and add circles:
var svg = d3.select("#mapid")
            .select("svg")
      
var Tooltip = d3.select("#mapid")
      .append("div")
	  .attr("id","mytooltip")
      .attr("class", "leaflet-pane leaflet-tooltip-pane")
      .style("opacity", 1)
      .style("background-color", "#B0E0E6")
      .style("border", "solid")
      .style("border-width", "2px")
      .style("border-radius", "10px")
      .style("padding", "5px")
	  
var in_circle = function(d) {
      Tooltip.style("opacity", 1)
	  d3.select(this)
   	    .attr("fill", "#6A5ACD");
    }	
var out_circle = function(d) {
      Tooltip.style("opacity", 0)
	  d3.select(this)
        .attr("fill",  getColor(d.Average_Score));  }	
var showme = function(d) {

  d3.select(this)
        .style("cursor", "pointer");

         Tooltip
        .html("Hotel Name: " + d.Hotel_Name.toString() + "<br>" + "Score: " + d.Average_Score + "<br>" + "Adress: " + d.Hotel_Address.toString())
	    .style("left", 50 + "px")
      .style("background-color",  getColor(d.Average_Score));

      
		//(map.latLngToLayerPoint(d.Coordinates).x) + "px")
		//.style("top", 400+ "px")
    
	    
    }
/////////////////////////////////////	
svg.selectAll("mycircle")
   .data(hotels)
   .enter()
   .append("circle")
     .attr("class" , function(d){ return d.group })
     .attr("cx", function(d){  return map.latLngToLayerPoint(d.Coordinates).x })
     .attr("cy", function(d){  return map.latLngToLayerPoint(d.Coordinates).y })
     .attr("r", function(d){return 0.08*((+d.Total_Number_of_Reviews)/50+80)})
     .attr("fill", function(d){return getColor(d.Average_Score) })
     .attr("stroke", "gray")
     .attr("stroke-width", 1.5)
    //  .attr("fill-opacity", .9)
   .on("mousemove", showme)
   .on("mouseover",in_circle)
   .on("mouseleave",out_circle)
   .on("click", function(d) { 
    	console.log(d["Hotel_Name"]); 
        map.setView(d.Coordinates, map.getZoom());
        pos_review(pos_cloud, d["Hotel_Name"]);
        neg_review(neg_cloud, d["Hotel_Name"]);
        
        
    document.getElementById("PositiveComments").innerHTML= ("PositiveComments"  )
    document.getElementById("NegativeComments").innerHTML= ("NegativeComments "  )
    document.getElementById("PieComments").innerHTML= ("PieComments"  )

        document.getElementById("Hotel_Name_display").innerHTML= ("Hotel Name: " + d.Hotel_Name.toString() )
        document.getElementById("Hotel_Score_display").innerHTML = ("Total Reviews: "+ d.Total_Number_of_Reviews.toString()+"&#09"+  " Average Score: " + d.Average_Score )
        document.getElementById("Hotel_Address_display").innerHTML = "Adress: " + d.Hotel_Address.toString()+ "<hr>"

        pieChart(d["Hotel_Name"],1)
    
        
	    });

//////////////////////////////////////////////////////
    // This function is gonna change the opacity and size of selected and unselected circles
function update_group(){

      // For each check box:
    d3.selectAll(".checkbox").each(function(d){
        cb = d3.select(this);
        grp = cb.property("value")

        // If the box is check, I show the group
        if(cb.property("checked")){
          svg.selectAll("."+grp).transition().duration(1000).style("opacity", 1).attr("r", function(d){ return 0.08*((+d.Total_Number_of_Reviews)/50+80)} )

        // Otherwise I hide it
        }else{
          svg.selectAll("."+grp).transition().duration(1000).style("opacity", 0).attr("r", 0)
        }
      })
    }

    // When a button change, I run the update function
d3.selectAll(".checkbox").on("change",update_group)

    // And I initialize it at the beginning
//update_group()




///////////////////////////////////////////

 
// Function that update circle position if something change
function update_circle() {
  d3.selectAll("circle")
    .attr("cx", function(d){ return map.latLngToLayerPoint(d.Coordinates).x })
    .attr("cy", function(d){ return map.latLngToLayerPoint(d.Coordinates).y })
    
}
// If the user change the map (zoom or drag), I update circle position:

map.on("moveend", update_circle)
//map.on("moveend",update_tooltip)

//bot right legend
var legend = L.control({position: 'bottomright'});

legend.onAdd = function (map) {

  var div = L.DomUtil.create('div', 'info legend'),
    grades = [  "<6",6.5, 7,7.5,8,8.5,9,9.5],
    labels = [],
    from, to ;

  for (var i = 0; i < grades.length; i++) {
    from = grades[i];
    to = grades[i + 1];

    labels.push(
      '<i style="background:' + getColor(from ) + '"></i> ' +
      from );
  }

  div.innerHTML = labels.join('<br>');
  return div;
};


legend.addTo(map);





</script>